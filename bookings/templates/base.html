{% load static %}
<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2b6cff">
    <meta name="description" content="PrenoPinzo - Gestione prenotazioni casa vacanza">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PrenoPinzo">
    <meta name="mobile-web-app-capable" content="yes">
    <title>PrenoPinzo {% block title %}{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'bookings/favicon.svg' %}">
    <link rel="icon" type="image/png" href="{% static 'bookings/favicon.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'bookings/icon-180.png' %}">
    <link rel="apple-touch-icon" sizes="167x167" href="{% static 'bookings/icon-167.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'bookings/icon-152.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'bookings/icon-192.png' %}">
    <link rel="manifest" href="{% static 'bookings/manifest.json' %}">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- App styles -->
    <link rel="stylesheet" href="{% static 'bookings/app.css' %}">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    {% block extra_head %}{% endblock %}
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4">
        <div class="container">
            <a class="navbar-brand" href="{% url 'dashboard' %}"><i class="fa-solid fa-mountain-sun"></i>
                PrenoPinzo</a>
            <div class="d-flex align-items-center d-lg-none">
                <a id="mobile-chat-badge" href="{% url 'chat' %}"
                    class="badge bg-danger rounded-pill me-2 text-decoration-none app-chat-badge">
                    <i class="fa-solid fa-comment"></i> <span id="mobile-unread-count">0</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}"><i class="fa-solid fa-house"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'calendar' %}"><i class="fa-solid fa-calendar-days"></i>
                            Calendario</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'statistics' %}"><i class="fa-solid fa-chart-pie"></i>
                            Statistiche</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'utilities' %}" title="Utilità">
                            <i class="fa-solid fa-toolbox"></i> Utilità
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ownership_periods' %}" title="Periodi di Pertinenza">
                            <i class="fa-solid fa-calendar-check"></i> Pertinenze
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'chat' %}">
                            <i class="fa-solid fa-comments"></i> Chat
                            <span id="desktop-chat-badge" class="badge bg-info rounded-pill ms-1 app-chat-badge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'help' %}" title="Guida">
                            <i class="fa-solid fa-circle-question"></i> Aiuto
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    {% if user.is_authenticated %}
                    <span class="navbar-text me-3 d-flex align-items-center">
                        {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="Ava" class="rounded-circle me-2 app-avatar">
                        {% else %}
                        <span
                            class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2 app-avatar-fallback">
                            {{ user.username|make_list|first|upper }}
                        </span>
                        {% endif %}

                        <span>
                            Ciao, <strong>{{ user.username }}</strong>
                            <a href="{% url 'profile' %}" class="text-decoration-none ms-1 text-secondary"
                                title="Configurazione Profilo">
                                <i class="fa-solid fa-gear"></i>
                            </a>
                            <small class="text-muted d-block app-user-family">{{ user.profile.get_family_group_display }}</small>
                        </span>
                    </span>
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button class="btn btn-outline-danger btn-sm" type="submit">Logout</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        const csrfSafeMethods = ['GET', 'HEAD', 'OPTIONS', 'TRACE'];
        const originalFetch = window.fetch.bind(window);
        let csrfAlertShown = false;

        window.fetch = (input, init = {}) => {
            const url = typeof input === 'string' ? input : input?.url || '';
            const method = (init.method || input?.method || 'GET').toUpperCase();
            const isSameOrigin = url.startsWith('/') || url.startsWith(window.location.origin);

            if (isSameOrigin && !csrfSafeMethods.includes(method)) {
                const headers = new Headers(init.headers || {});
                if (!headers.has('X-CSRFToken')) {
                    headers.set('X-CSRFToken', getCookie('csrftoken'));
                }
                init.headers = headers;
            }

            return originalFetch(input, init).then(async (response) => {
                if (!response.ok && response.status === 403 && !csrfAlertShown && !csrfSafeMethods.includes(method)) {
                    try {
                        const cloned = response.clone();
                        const text = await cloned.text();
                        if (text.toLowerCase().includes('csrf')) {
                            csrfAlertShown = true;
                            if (window.Swal) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Sessione scaduta',
                                    text: 'Per motivi di sicurezza la sessione è scaduta. Ricarica la pagina e riprova.',
                                    confirmButtonText: 'Ricarica',
                                    showCancelButton: true,
                                    cancelButtonText: 'Chiudi'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.reload();
                                    } else {
                                        csrfAlertShown = false;
                                    }
                                });
                            } else {
                                alert('Sessione scaduta. Ricarica la pagina e riprova.');
                                window.location.reload();
                            }
                        }
                    } catch (_) {
                        // ignore
                    }
                }
                return response;
            });
        };

        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = getCookie('csrftoken');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            });
        }

        // Check for unread chat messages
        function checkUnreadChat() {
            fetch('/api/chat/unread/')
                .then(r => r.json())
                .then(data => {
                    updateBadge('mobile-chat-badge', data.count, 'mobile-unread-count');
                    updateBadge('desktop-chat-badge', data.count);
                })
                .catch(() => { }); // Ignore errors silently
        }

        function updateBadge(badgeId, count, countId = null) {
            const badge = document.getElementById(badgeId);
            if (!badge) return;

            badge.style.display = 'inline-block';
            let displayCount = count > 9 ? '9+' : count;

            if (countId) {
                const countEl = document.getElementById(countId);
                if (countEl) countEl.textContent = displayCount;
            } else {
                badge.textContent = displayCount;
            }

            if (count > 0) {
                badge.classList.remove('bg-info');
                badge.classList.add('bg-danger');
            } else {
                badge.classList.remove('bg-danger');
                badge.classList.add('bg-info');
            }
        }

        // Check immediately and every 5 seconds for near real-time updates
        {% if user.is_authenticated %}
        checkUnreadChat();
        setInterval(checkUnreadChat, 5000);
        {% endif %}
    </script>
    {% block extra_scripts %}{% endblock %}
</body>

</html>
