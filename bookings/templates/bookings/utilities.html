{% extends 'base.html' %}

{% block title %} - Utilità{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="text-center mb-5">
                <h1 class="display-4"><i class="fa-solid fa-toolbox text-primary"></i> Utilità</h1>
                <p class="lead text-muted">Strumenti utili per pianificare la tua vacanza a Pinzolo</p>
            </div>

            <div class="row">
                <!-- Webcam Card -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header app-card-header app-card-header--primary">
                            <h5 class="mb-0"><i class="fa-solid fa-camera"></i> Webcam Pinzolo</h5>
                        </div>
                        <div class="card-body text-center">
                            <img id="webcam-image" 
                                 src="https://www.fioccodineve.com/images/webcam/webcam/image.jpg" 
                                 alt="Webcam Pinzolo" 
                                 class="img-fluid rounded shadow app-webcam-image"
                                 onclick="refreshWebcam()"
                                 title="Clicca per aggiornare">
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshWebcam()">
                                    <i class="fa-solid fa-refresh"></i> Aggiorna Immagine
                                </button>
                                <p class="text-muted small mt-2 mb-0">
                                    <i class="fa-solid fa-clock"></i> Ultimo aggiornamento: <span id="webcam-time">--</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather Card -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header app-card-header app-card-header--success">
                            <h5 class="mb-0"><i class="fa-solid fa-cloud-sun"></i> Meteo Pinzolo</h5>
                        </div>
                        <div class="card-body">
                            <!-- Open-Meteo Widget - Free, no API key required -->
                            <div id="weather-container">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Caricamento previsioni...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Forecast Details -->
            <div class="card mb-4">
                <div class="card-header app-card-header app-card-header--info">
                    <h5 class="mb-0"><i class="fa-solid fa-calendar-days"></i> Previsioni 7 Giorni</h5>
                </div>
                <div class="card-body">
                    <div id="forecast-container" class="row">
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thermostat Control -->
            <div class="card mb-4">
                <div class="card-header app-card-header app-card-header--warning">
                    <h5 class="mb-0"><i class="fa-solid fa-temperature-half"></i> Riscaldamento Casa</h5>
                </div>
                <div class="card-body">
                    <div id="thermostat-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Connessione a Home Assistant...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ski Resort Info -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header app-card-header app-card-header--info">
                            <h5 class="mb-0"><i class="fa-solid fa-person-skiing"></i> Stato Piste e Impianti</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Consulta lo stato degli impianti e delle piste di Madonna di Campiglio - Pinzolo:</p>
                            <div class="d-grid gap-2">
                                <a href="https://www.skiinfo.it/trentino/madonna-di-campiglio/bollettino-neve" target="_blank" class="btn btn-outline-primary">
                                    <i class="fa-solid fa-mountain-sun me-2"></i> SkiInfo - Stato Piste
                                </a>
                                <a href="https://www.campigliodolomiti.it/it/live-info/webcam" target="_blank" class="btn btn-outline-primary">
                                    <i class="fa-solid fa-video me-2"></i> Campiglio Dolomiti - Webcam
                                </a>
                                <a href="https://www.skirama.it/it/piste-sci-impianti" target="_blank" class="btn btn-outline-info">
                                    <i class="fa-solid fa-list me-2"></i> Skirama - Piste e Impianti
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header app-card-header app-card-header--neutral">
                            <h5 class="mb-0"><i class="fa-solid fa-snowflake"></i> Altezza Neve</h5>
                        </div>
                        <div class="card-body">
                            <div id="snow-container">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Caricamento dati neve...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Useful Numbers -->
            <div class="card mb-4">
                <div class="card-header app-card-header app-card-header--danger">
                    <h5 class="mb-0"><i class="fa-solid fa-phone"></i> Numeri Utili</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card border-danger h-100">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-truck-medical fa-2x text-danger mb-2"></i>
                                    <h6 class="fw-bold">Emergenze</h6>
                                    <a href="tel:112" class="btn btn-danger btn-sm">
                                        <i class="fa-solid fa-phone"></i> 112
                                    </a>
                                    <p class="small text-muted mt-2 mb-0">Numero Unico Emergenze</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-prescription-bottle-medical fa-2x text-success mb-2"></i>
                                    <h6 class="fw-bold">Farmacia Pinzolo</h6>
                                    <a href="tel:+390465501076" class="btn btn-success btn-sm">
                                        <i class="fa-solid fa-phone"></i> 0465 501076
                                    </a>
                                    <p class="small text-muted mt-2 mb-0">Via Genova, 60</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-user-doctor fa-2x text-primary mb-2"></i>
                                    <h6 class="fw-bold">Guardia Medica</h6>
                                    <a href="tel:+390465501280" class="btn btn-primary btn-sm">
                                        <i class="fa-solid fa-phone"></i> 0465 501280
                                    </a>
                                    <p class="small text-muted mt-2 mb-0">Servizio notturno/festivo</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-taxi fa-2x text-warning mb-2"></i>
                                    <h6 class="fw-bold">Taxi Pinzolo</h6>
                                    <a href="tel:+393356140008" class="btn btn-warning btn-sm text-dark">
                                        <i class="fa-solid fa-phone"></i> 335 6140008
                                    </a>
                                    <p class="small text-muted mt-2 mb-0">Servizio taxi locale</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Calendar -->
            <div class="card mb-4">
                <div class="card-header app-card-header app-card-header--primary">
                    <h5 class="mb-0"><i class="fa-solid fa-calendar-star"></i> Eventi in Zona</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Scopri gli eventi, mercatini e manifestazioni nella Val Rendena:</p>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <a href="https://www.campigliodolomiti.it/it/eventi" target="_blank" class="card text-decoration-none h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-mountain fa-3x text-primary mb-3"></i>
                                    <h6>Campiglio Dolomiti</h6>
                                    <small class="text-muted">Eventi ufficiali della zona</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4 mb-3">
                            <a href="https://www.campanedipinzolo.it/" target="_blank" class="card text-decoration-none h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-tree fa-3x text-success mb-3"></i>
                                    <h6>Informazioni locali</h6>
                                    <small class="text-muted">Giornale locale</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4 mb-3">
                            <a href="https://www.visittrentino.info/en/guide/what-to-do/events" target="_blank" class="card text-decoration-none h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="fa-solid fa-map-location-dot fa-3x text-info mb-3"></i>
                                    <h6>Visit Trentino</h6>
                                    <small class="text-muted">Eventi in tutto il Trentino</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to Dashboard -->
            <div class="text-center mt-4">
                <a href="{% url 'dashboard' %}" class="btn btn-primary btn-lg">
                    <i class="fa-solid fa-arrow-left"></i> Torna alla Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Webcam refresh with timestamp
function refreshWebcam() {
    const img = document.getElementById('webcam-image');
    const timestamp = Date.now();
    img.src = `https://www.fioccodineve.com/images/webcam/webcam/image.jpg?t=${timestamp}`;
    
    const timeSpan = document.getElementById('webcam-time');
    const now = new Date();
    timeSpan.textContent = now.toLocaleTimeString('it-IT');
}

// Weather icons mapping
const weatherIcons = {
    0: 'fa-sun',           // Clear sky
    1: 'fa-sun',           // Mainly clear
    2: 'fa-cloud-sun',     // Partly cloudy
    3: 'fa-cloud',         // Overcast
    45: 'fa-smog',         // Fog
    48: 'fa-smog',         // Depositing rime fog
    51: 'fa-cloud-rain',   // Light drizzle
    53: 'fa-cloud-rain',   // Moderate drizzle
    55: 'fa-cloud-rain',   // Dense drizzle
    61: 'fa-cloud-showers-heavy', // Slight rain
    63: 'fa-cloud-showers-heavy', // Moderate rain
    65: 'fa-cloud-showers-heavy', // Heavy rain
    71: 'fa-snowflake',    // Slight snow
    73: 'fa-snowflake',    // Moderate snow
    75: 'fa-snowflake',    // Heavy snow
    77: 'fa-snowflake',    // Snow grains
    80: 'fa-cloud-rain',   // Slight rain showers
    81: 'fa-cloud-showers-heavy', // Moderate rain showers
    82: 'fa-cloud-showers-heavy', // Violent rain showers
    85: 'fa-snowflake',    // Slight snow showers
    86: 'fa-snowflake',    // Heavy snow showers
    95: 'fa-bolt',         // Thunderstorm
    96: 'fa-bolt',         // Thunderstorm with slight hail
    99: 'fa-bolt',         // Thunderstorm with heavy hail
};

const weatherDescriptions = {
    0: 'Sereno',
    1: 'Prevalentemente sereno',
    2: 'Parzialmente nuvoloso',
    3: 'Nuvoloso',
    45: 'Nebbia',
    48: 'Nebbia gelata',
    51: 'Pioviggine leggera',
    53: 'Pioviggine',
    55: 'Pioviggine intensa',
    61: 'Pioggia leggera',
    63: 'Pioggia moderata',
    65: 'Pioggia intensa',
    71: 'Neve leggera',
    73: 'Neve moderata',
    75: 'Neve intensa',
    77: 'Granelli di neve',
    80: 'Rovesci leggeri',
    81: 'Rovesci moderati',
    82: 'Rovesci intensi',
    85: 'Rovesci di neve leggeri',
    86: 'Rovesci di neve intensi',
    95: 'Temporale',
    96: 'Temporale con grandine',
    99: 'Temporale con grandine intensa',
};

// Fetch weather from Open-Meteo (free, no API key)
async function loadWeather() {
    // Pinzolo coordinates
    const lat = 46.1603;
    const lon = 10.7653;
    
    try {
        const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
            `&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m` +
            `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max` +
            `&timezone=Europe/Rome`
        );
        const data = await response.json();
        
        // Current weather
        const current = data.current;
        const weatherCode = current.weather_code;
        const icon = weatherIcons[weatherCode] || 'fa-question';
        const description = weatherDescriptions[weatherCode] || 'N/D';
        
        document.getElementById('weather-container').innerHTML = `
            <div class="text-center">
                <i class="fa-solid ${icon} fa-4x text-primary mb-3"></i>
                <h2 class="display-4 mb-2">${Math.round(current.temperature_2m)}°C</h2>
                <p class="lead mb-2">${description}</p>
                <div class="row text-muted small">
                    <div class="col-6">
                        <i class="fa-solid fa-droplet"></i> Umidità: ${current.relative_humidity_2m}%
                    </div>
                    <div class="col-6">
                        <i class="fa-solid fa-wind"></i> Vento: ${Math.round(current.wind_speed_10m)} km/h
                    </div>
                </div>
            </div>
        `;
        
        // 7-day forecast
        const daily = data.daily;
        let forecastHTML = '';
        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
        
        for (let i = 0; i < 7; i++) {
            const dateObj = new Date(daily.time[i]);
            const dayName = dayNames[dateObj.getDay()];
            const dayNum = dateObj.getDate();
            const wCode = daily.weather_code[i];
            const fIcon = weatherIcons[wCode] || 'fa-question';
            const maxTemp = Math.round(daily.temperature_2m_max[i]);
            const minTemp = Math.round(daily.temperature_2m_min[i]);
            const precip = daily.precipitation_probability_max[i];
            
            forecastHTML += `
                <div class="col-6 col-md-3 col-lg mb-3">
                    <div class="card text-center h-100 ${i === 0 ? 'border-primary' : ''}">
                        <div class="card-body py-2 px-1">
                            <p class="mb-1 fw-bold ${i === 0 ? 'text-primary' : ''}">${dayName} ${dayNum}</p>
                            <i class="fa-solid ${fIcon} fa-2x mb-2 ${i === 0 ? 'text-primary' : 'text-secondary'}"></i>
                            <p class="mb-0">
                                <span class="text-danger fw-bold">${maxTemp}°</span>
                                <span class="text-muted">/</span>
                                <span class="text-primary">${minTemp}°</span>
                            </p>
                            <small class="text-muted">
                                <i class="fa-solid fa-umbrella"></i> ${precip}%
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('forecast-container').innerHTML = forecastHTML;
        
    } catch (error) {
        console.error('Error loading weather:', error);
        document.getElementById('weather-container').innerHTML = `
            <div class="alert alert-warning">
                <i class="fa-solid fa-exclamation-triangle"></i> Impossibile caricare le previsioni meteo.
            </div>
        `;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshWebcam();
    loadWeather();
    loadSnowData();
    loadThermostat();
});

// ============================================================
// Thermostat Control
// ============================================================
let thermostatData = null;
let scheduleData = null;

async function loadThermostat() {
    const container = document.getElementById('thermostat-container');
    
    try {
        // Load both thermostat and schedule data in parallel
        const [thermostatResponse, scheduleResponse] = await Promise.all([
            fetch('/api/thermostat/status/'),
            fetch('/api/thermostat/schedule-options/')
        ]);
        
        if (!thermostatResponse.ok) {
            const error = await thermostatResponse.json();
            throw new Error(error.error || 'Errore sconosciuto');
        }
        
        thermostatData = await thermostatResponse.json();
        
        if (scheduleResponse.ok) {
            scheduleData = await scheduleResponse.json();
        }
        
        renderThermostat();
        
    } catch (error) {
        console.error('Error loading thermostat:', error);
        container.innerHTML = `
            <div class="alert alert-warning mb-0">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Termostato non disponibile</strong><br>
                <small>${error.message}</small>
                <button class="btn btn-sm btn-outline-warning mt-2" onclick="loadThermostat()">
                    <i class="fa-solid fa-refresh"></i> Riprova
                </button>
            </div>
        `;
    }
}

function renderThermostat() {
    if (!thermostatData) return;
    
    const container = document.getElementById('thermostat-container');
    const currentTemp = thermostatData.current_temperature || '--';
    const targetTemp = thermostatData.target_temperature || 20;
    const state = thermostatData.state || 'off';
    const hvacAction = thermostatData.hvac_action || 'idle';
    
    // Determine heating status icon and color
    let statusIcon, statusColor, statusText;
    if (hvacAction === 'heating') {
        statusIcon = 'fa-fire';
        statusColor = 'text-danger';
        statusText = 'Riscaldamento attivo';
    } else if (state === 'heat') {
        statusIcon = 'fa-power-off';
        statusColor = 'text-success';
        statusText = 'Pronto (standby)';
    } else {
        statusIcon = 'fa-power-off';
        statusColor = 'text-secondary';
        statusText = 'Spento';
    }
    
    container.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4 text-center mb-3 mb-md-0">
                <i class="fa-solid ${statusIcon} fa-3x ${statusColor} mb-2"></i>
                <h2 class="display-5 mb-0">${currentTemp}°C</h2>
                <small class="text-muted">Temperatura attuale</small>
                <p class="mt-2 mb-0"><span class="badge ${hvacAction === 'heating' ? 'bg-danger' : 'bg-secondary'}">${statusText}</span></p>
            </div>
            <div class="col-md-8">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="fa-solid fa-sliders"></i> Imposta Temperatura Target</h6>
                        <div class="d-flex align-items-center justify-content-center gap-3">
                            <button class="btn btn-lg btn-outline-primary" onclick="adjustTemp(-0.5)" ${targetTemp <= 7 ? 'disabled' : ''}>
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <div class="text-center app-target-temp">
                                <h3 class="display-6 mb-0" id="target-temp-display">${targetTemp}°C</h3>
                                <small class="text-muted">Target</small>
                            </div>
                            <button class="btn btn-lg btn-outline-danger" onclick="adjustTemp(0.5)" ${targetTemp >= 30 ? 'disabled' : ''}>
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div class="mt-3 text-center">
                            <button class="btn btn-warning" onclick="setTemperature()" id="set-temp-btn">
                                <i class="fa-solid fa-paper-plane"></i> Applica
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadThermostat()">
                                <i class="fa-solid fa-refresh"></i> Aggiorna
                            </button>
                        </div>
                        ${scheduleData && scheduleData.options && scheduleData.options.length > 0 ? `
                        <hr class="my-3">
                        <h6 class="mb-3"><i class="fa-solid fa-calendar-alt"></i> Programma Attivo: <span class="badge bg-info">${scheduleData.current || thermostatData.preset_mode || 'N/D'}</span></h6>
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            ${scheduleData.options.map(option => `
                                <button class="btn btn-sm ${scheduleData.current === option ? 'btn-primary' : 'btn-outline-primary'}" onclick="setSchedule('${option}')">
                                    <i class="fa-solid fa-calendar-day"></i> ${option}
                                </button>
                            `).join('')}
                            <button class="btn btn-sm ${thermostatData.preset_mode === 'away' ? 'btn-warning' : 'btn-outline-warning'}" onclick="setPreset('away')">
                                <i class="fa-solid fa-suitcase"></i> Assenza
                            </button>
                        </div>
                        ` : ''}
                        <div class="alert alert-info mt-3 mb-0 small">
                            <i class="fa-solid fa-info-circle"></i> <strong>Attenzione:</strong> Il cambio di programma o temperatura richiede almeno 10 minuti. Impostare il programma e ricaricare la pagina successivamente.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function adjustTemp(delta) {
    if (!thermostatData) return;
    
    let newTemp = (thermostatData.target_temperature || 20) + delta;
    newTemp = Math.max(7, Math.min(30, newTemp));
    thermostatData.target_temperature = newTemp;
    
    document.getElementById('target-temp-display').textContent = `${newTemp}°C`;
}

async function setTemperature() {
    if (!thermostatData) return;
    
    const btn = document.getElementById('set-temp-btn');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Invio...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/thermostat/set-temp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                temperature: thermostatData.target_temperature
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Errore');
        }
        
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Impostato!';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            loadThermostat();
        }, 2000);
        
    } catch (error) {
        console.error('Error setting temperature:', error);
        alert('Errore: ' + error.message);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}

function getCsrfToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [key, value] = cookie.trim().split('=');
        if (key === name) return value;
    }
    return '';
}

async function setSchedule(scheduleName) {
    if (!scheduleData) return;
    
    try {
        const response = await fetch('/api/thermostat/set-schedule/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                schedule: scheduleName
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Errore');
        }
        
        // Reload to show updated state
        setTimeout(() => {
            loadThermostat();
        }, 500);
        
    } catch (error) {
        console.error('Error setting schedule:', error);
        alert('Errore nel cambiare programma: ' + error.message);
    }
}

async function setPreset(presetMode) {
    if (!thermostatData) return;
    
    try {
        const response = await fetch('/api/thermostat/set-preset/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                preset: presetMode
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Errore');
        }
        
        // Reload to show updated state
        setTimeout(() => {
            loadThermostat();
        }, 500);
        
    } catch (error) {
        console.error('Error setting preset:', error);
        alert('Errore nel cambiare modalità: ' + error.message);
    }
}




// Load snow depth data from Open-Meteo
async function loadSnowData() {
    // Madonna di Campiglio coordinates (higher altitude for snow data)
    const lat = 46.2297;
    const lon = 10.8264;
    
    try {
        const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
            `&current=snow_depth` +
            `&daily=snowfall_sum` +
            `&timezone=Europe/Rome`
        );
        const data = await response.json();
        
        const snowDepth = data.current?.snow_depth || 0;
        const todaySnowfall = data.daily?.snowfall_sum?.[0] || 0;
        const tomorrowSnowfall = data.daily?.snowfall_sum?.[1] || 0;
        
        document.getElementById('snow-container').innerHTML = `
            <div class="row text-center">
                <div class="col-4">
                    <i class="fa-solid fa-mountain-sun fa-2x text-info mb-2"></i>
                    <h4 class="mb-0">${Math.round(snowDepth)} cm</h4>
                    <small class="text-muted">Manto nevoso</small>
                </div>
                <div class="col-4">
                    <i class="fa-solid fa-cloud-snow fa-2x text-primary mb-2"></i>
                    <h4 class="mb-0">${Math.round(todaySnowfall)} cm</h4>
                    <small class="text-muted">Neve oggi</small>
                </div>
                <div class="col-4">
                    <i class="fa-solid fa-snowflake fa-2x text-secondary mb-2"></i>
                    <h4 class="mb-0">${Math.round(tomorrowSnowfall)} cm</h4>
                    <small class="text-muted">Neve domani</small>
                </div>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="fa-solid fa-location-dot"></i> Dati stazione Madonna di Campiglio
                </small>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading snow data:', error);
        document.getElementById('snow-container').innerHTML = `
            <div class="alert alert-info mb-0">
                <i class="fa-solid fa-info-circle"></i> Dati neve non disponibili. 
                <a href="https://www.skirama.it/it/bollettino-neve" target="_blank">Consulta il bollettino</a>
            </div>
        `;
    }
}
</script>
{% endblock %}
