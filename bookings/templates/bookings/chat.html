{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block extra_head %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0 app-page-title"><i class="fa-solid fa-comments me-2"></i>Chat Famiglia</h4>
    <span id="online-status" class="badge bg-secondary">Connessione...</span>
</div>

<div id="status-indicator" class="status-indicator"></div>

<div class="card">
    <div class="chat-container">
        <div id="chat-messages" class="chat-messages">
            <!-- Messages will be inserted here -->
        </div>
        
        <div id="typing-indicator" class="typing-indicator">
            <i class="fa-solid fa-ellipsis fa-beat-fade"></i> <span id="typing-user"></span> sta scrivendo...
        </div>
        
        <div class="chat-input-area">
            <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()">
                ğŸ˜€
            </button>
            <input type="text" id="chat-input" class="chat-input" 
                   placeholder="Scrivi un messaggio..." autocomplete="off">
            <button type="button" class="send-btn" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Emoji Picker -->
<div id="emoji-picker" class="emoji-picker-container">
    <div class="emoji-grid">
        {% for emoji in "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ¤£ğŸ˜‚ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŠğŸ˜‡ğŸ¥°ğŸ˜ğŸ¤©ğŸ˜˜ğŸ˜—â˜ºğŸ˜šğŸ˜™ğŸ¥²ğŸ˜‹ğŸ˜›ğŸ˜œğŸ¤ªğŸ˜ğŸ¤‘ğŸ¤—ğŸ¤­ğŸ¤«ğŸ¤”ğŸ¤ğŸ¤¨ğŸ˜ğŸ˜‘ğŸ˜¶ğŸ˜ğŸ˜’ğŸ™„ğŸ˜¬ğŸ¤¯ğŸ˜³ğŸ¥µğŸ¥¶ğŸ˜±ğŸ˜¨ğŸ˜°ğŸ˜¥ğŸ˜¢ğŸ˜­ğŸ˜¤ğŸ˜ ğŸ˜¡ğŸ¤¬ğŸ¤¡ğŸ‘ğŸ‘ğŸ‘ŠâœŠğŸ¤âœŒğŸ¤ŸğŸ¤™ğŸ‘‹ğŸ™ğŸ’ªğŸ”ï¸ğŸ ğŸŒğŸ¿â›·ï¸ğŸºğŸ»ğŸ·ğŸ‰ğŸŠâœˆï¸ğŸš—" %}
        <span class="emoji-item" onclick="insertEmoji('{{ emoji }}')">{{ emoji }}</span>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const currentUser = '{{ user.username }}';
    const currentFamily = '{{ user.profile.family_group }}';
    let chatSocket = null;
    let typingTimeout = null;
    let lastTypingSent = 0;
    
    // Connect WebSocket
    function connectWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/`);
        
        chatSocket.onopen = function(e) {
            document.getElementById('online-status').textContent = 'Online';
            document.getElementById('online-status').className = 'badge bg-success';
        };
        
        chatSocket.onclose = function(e) {
            document.getElementById('online-status').textContent = 'Offline';
            document.getElementById('online-status').className = 'badge bg-danger';
            // Reconnect after 3 seconds
            setTimeout(connectWebSocket, 3000);
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleMessage(data);
        };
    }
    
    function handleMessage(data) {
        switch(data.type) {
            case 'chat_history':
                renderHistory(data.messages);
                break;
            case 'message':
                appendMessage(data);
                break;
            case 'typing':
                showTypingIndicator(data.username, data.is_typing);
                break;
            case 'status':
                showStatusMessage(data.username, data.status);
                break;
        }
    }
    
    function renderHistory(messages) {
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';
        
        let lastDate = null;
        messages.forEach(msg => {
            // Add date separator if needed
            if (msg.date !== lastDate) {
                container.innerHTML += `<div class="date-separator"><span>${msg.date}</span></div>`;
                lastDate = msg.date;
            }
            appendMessage(msg, false);
        });
        
        scrollToBottom();
    }
    
    function appendMessage(msg, scroll = true) {
        const container = document.getElementById('chat-messages');
        const isMine = msg.sender === currentUser;
        
        const messageHtml = `
            <div class="message ${isMine ? 'mine' : 'theirs'}">
                ${!isMine ? `<div class="message-sender">${msg.sender} (${msg.sender_family})</div>` : ''}
                <div class="message-content">${escapeHtml(msg.content)}</div>
                <div class="message-time">${msg.timestamp}</div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', messageHtml);
        
        if (scroll) {
            scrollToBottom();
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function scrollToBottom() {
        const container = document.getElementById('chat-messages');
        container.scrollTop = container.scrollHeight;
    }
    
    function sendMessage() {
        const input = document.getElementById('chat-input');
        const content = input.value.trim();
        
        if (content && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'message',
                content: content
            }));
            input.value = '';
            
            // Stop typing indicator
            chatSocket.send(JSON.stringify({
                type: 'typing',
                is_typing: false
            }));
        }
        
        // Close emoji picker
        document.getElementById('emoji-picker').classList.remove('active');
    }
    
    function showTypingIndicator(username, isTyping) {
        const indicator = document.getElementById('typing-indicator');
        const userSpan = document.getElementById('typing-user');
        
        if (isTyping) {
            userSpan.textContent = username;
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    }
    
    function showStatusMessage(username, status) {
        const indicator = document.getElementById('status-indicator');
        indicator.textContent = `${username} Ã¨ ${status === 'online' ? 'entrato' : 'uscito'} dalla chat`;
        indicator.classList.add('active');
        
        setTimeout(() => {
            indicator.classList.remove('active');
        }, 3000);
    }
    
    function toggleEmojiPicker() {
        document.getElementById('emoji-picker').classList.toggle('active');
    }
    
    function insertEmoji(emoji) {
        const input = document.getElementById('chat-input');
        input.value += emoji;
        input.focus();
    }
    
    // Event listeners
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Typing indicator - send every 2 seconds max
    document.getElementById('chat-input').addEventListener('input', function() {
        const now = Date.now();
        if (now - lastTypingSent > 2000 && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'typing',
                is_typing: true
            }));
            lastTypingSent = now;
        }
        
        // Clear previous timeout
        clearTimeout(typingTimeout);
        
        // Stop typing after 3 seconds of no input
        typingTimeout = setTimeout(() => {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: 'typing',
                    is_typing: false
                }));
            }
        }, 3000);
    });
    
    // Close emoji picker when clicking outside
    document.addEventListener('click', function(e) {
        const picker = document.getElementById('emoji-picker');
        const emojiBtn = document.querySelector('.emoji-btn');
        if (!picker.contains(e.target) && e.target !== emojiBtn) {
            picker.classList.remove('active');
        }
    });
    
    // Connect on page load
    connectWebSocket();
    
    // Mark messages as read when page is visible
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ type: 'mark_read' }));
        }
    });
</script>
{% endblock %}
